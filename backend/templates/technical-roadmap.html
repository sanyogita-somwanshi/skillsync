<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkillSync - Technical Roadmap</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom colors based on the aesthetic goal */
        .color-primary { background-color: #0d9488; } /* Deep Teal */
        .color-accent { background-color: #38bdf8; } /* Vibrant Cyan */
        .rounded-xl-lg { border-radius: 1.5rem; }
        .transition-ease { transition: all 0.3s ease-in-out; }
        .progress-bg { background-color: #e0f2f1; } /* Light Teal */
        .completed { text-decoration: line-through; opacity: 0.6; color: #10b981; }

        /* --- CHATBOT WIDGET CSS --- */
        .chatbot-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
            cursor: pointer;
        }
        .chatbot-icon {
            box-shadow: 0 10px 15px -3px rgba(13, 148, 136, 0.5), 0 4px 6px -2px rgba(13, 148, 136, 0.1);
        }
        .chatbot-window {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: min(90vw, 400px);
            height: min(70vh, 600px);
            z-index: 1001;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        /* Style for user messages */
        .user-message {
            background-color: #38bdf8; /* Vibrant Cyan */
            color: white;
            border-radius: 1rem 1rem 0.2rem 1rem;
            padding: 8px 12px;
            margin-bottom: 8px;
            text-align: right;
            align-self: flex-end;
            max-width: 80%;
        }
        /* Style for AI messages */
        .ai-message {
            background-color: #f0fdfa; /* Light Teal */
            border: 1px solid #0d9488;
            border-radius: 1rem 1rem 1rem 0.2rem;
            padding: 8px 12px;
            margin-bottom: 8px;
            align-self: flex-start;
            max-width: 80%;
        }
    </style>
</head>

<body class="font-sans text-gray-800 antialiased min-h-screen flex flex-col bg-gray-50">

    <header class="sticky top-0 z-50 bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center h-20">
            <a href="{{ url_for('home') }}" class="text-3xl font-bold text-teal-600 tracking-wider">SkillSync</a>
            <a href="{{ url_for('dashboard') }}" class="text-gray-600 hover:text-teal-600 font-medium transition-ease">‚Üê Back to Dashboard</a>
        </div>
    </header>

    <main class="flex-grow py-16 md:py-20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            
            <h1 class="text-4xl font-extrabold text-gray-900 mb-2 text-center">
                Your Technical Skill Roadmap
            </h1>
            <p class="text-xl text-gray-600 mb-12 text-center max-w-3xl mx-auto">
                Define your goal and instantly see the *gap* between your current university skills and industry demands.
            </p>

            <div class="bg-white p-6 md:p-8 rounded-xl-lg shadow-xl mb-12 max-w-2xl mx-auto border-t-4 border-teal-500">
                <h2 class="text-2xl font-bold mb-4 text-gray-900">1. Select Your Technical Career Path</h2>
                
                <select id="career-goal-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500 transition duration-150 text-lg font-semibold" onchange="loadRoadmap()">
                    {% for goal in roadmap_groups %}
                        <option value="{{ goal }}">{{ goal }}</option>
                    {% endfor %}
                </select>

                <p id="goal-description" class="text-sm text-gray-500 italic mt-3">
                    Select a goal to load the required skills and start your assessment.
                </p>
            </div>

            <div class="bg-white p-6 md:p-10 rounded-xl-lg shadow-2xl mb-12">
                <h2 class="text-3xl font-bold text-gray-900 mb-8">2. Measure Your Skill Gap (Rate Current Level 1-5)</h2>

                <form id="skill-assessment-form" method="POST" action="{{ url_for('save_skills') }}">
                    <div id="skills-assessment-container" class="space-y-8">
                        <p class="text-center text-gray-500">Please select a career goal above to load the skills.</p>
                    </div>

                    <button type="submit" class="color-primary text-white font-bold text-lg py-3 w-full rounded-xl-lg shadow-xl hover:opacity-90 transition-ease mt-10">
                        Save My Progress & Update Roadmap
                    </button>
                </form>
            </div>

            <div class="bg-white p-6 md:p-10 rounded-xl-lg shadow-2xl">
                <h2 class="text-3xl font-bold text-gray-900 mb-4">3. Recommended Action Plan</h2>
                <p class="text-lg text-gray-600 mb-6">Based on your identified gaps, complete these actions. Mark them as done to save your progress!</p>
                
                <ul id="action-plan-list" class="space-y-4">
                    <li class="p-4 bg-gray-100 border-l-4 border-gray-400 rounded-lg shadow-sm">
                        <p class="font-semibold text-gray-900">Your personalized recommendations will appear here after you rate your skills and save.</p>
                    </li>
                </ul>
            </div>
            
        </div>
    </main>

    <footer class="py-8 bg-gray-900 text-white text-center">
        <div class="max-w-7xl mx-auto px-4">
            &copy; 2025 SkillSync.
        </div>
    </footer>
    
    <div id="chatbot-button" class="chatbot-button transition-ease hidden" onclick="toggleChatbot()">
        <div class="color-primary chatbot-icon rounded-full p-4 text-white hover:shadow-xl hover:scale-105 transition-ease flex items-center justify-center">
            <span class="text-3xl font-bold">üí¨</span>
        </div>
    </div>
    
    <div id="chatbot-window" class="chatbot-window bg-white rounded-xl-lg border-2 border-teal-500 flex flex-col hidden">
        <div class="p-4 color-primary text-white font-bold flex justify-between items-center rounded-t-xl-lg">
            <span>AI Career Guide</span>
            <button onclick="toggleChatbot()" class="text-xl font-light leading-none hover:text-gray-200">‚úï</button>
        </div>
        <div id="chat-messages" class="flex-grow p-4 overflow-y-auto flex flex-col">
             <div class="ai-message">
                Hello! I'm your AI Career Guide. Ask me about your roadmap or skills!
            </div>
        </div>
        <div class="p-4 border-t border-gray-200 flex">
            <input type="text" id="chat-input" placeholder="Ask me..." class="flex-grow p-2 border border-gray-300 rounded-l-lg focus:outline-none focus:border-teal-500">
            <button onclick="sendMessage()" id="send-button" class="bg-teal-600 text-white px-4 py-2 rounded-r-lg font-semibold hover:bg-teal-700 transition-ease">
                Send
            </button>
        </div>
    </div>
    
    <script>
        const API_KEY = "AIzaSyDJ_Zv3pC_c0CRlm_ULZk1h7BgN6ZW4wN4"; 
        const ALL_DB_SKILLS = {{ skill_data | tojson | safe }};
        
        const ROADMAP_STRUCTURE = {
            'Web Developer': ['HTML & CSS', 'JavaScript', 'Git & GitHub', 'APIs (RESTful)', 'Frontend Framework (React/Vue)', 'Backend Language (Python/Node)', 'Database (SQL/NoSQL)', 'Deployment (Cloud/Hosting)'],
            'Data Scientist': ['Probability & Statistics', 'Python (Pandas, NumPy)', 'SQL', 'Data Cleaning & Preprocessing', 'Machine Learning', 'Data Visualization', 'Big Data (Spark/Hadoop)', 'Deployment (APIs/Cloud)'],
            'Cybersecurity Analyst': ['Computer Fundamentals', 'Linux & Networking', 'Python for Automation', 'Security Tools (Nmap, Wireshark)', 'Web Security (OWASP)', 'Penetration Testing Basics', 'SOC/Blue Team Basics'],
            'App Developer': ['Java or Kotlin', 'Android Studio', 'UI/UX basics', 'Android components', 'Databases (Room, SQLite)', 'API integration', 'Firebase'],
            'Cloud Engineer': ['Linux basics', 'Networking (VPC, Subnets)', 'Cloud provider (AWS/Azure/GCP)', 'IAM', 'Compute (EC2, VM)', 'Storage (S3/Blob)', 'Databases (RDS, DynamoDB)', 'Monitoring & Security'],
            'AI/ML Engineer': ['Python (Adv. Libraries)', 'Stats & Probability', 'ML Algorithms', 'Deep Learning (TensorFlow/PyTorch)', 'Data Cleaning & Preprocessing', 'NLP / CV', 'Deployment (Docker, APIs)'],
            'UI/UX Designer': ['Design principles', 'Figma', 'Typography & Color Theory', 'Wireframes', 'Prototypes', 'User research', 'Portfolio building'],
            'Ethical Hacker': ['Linux fundamentals', 'Networking basics', 'Security concepts (CIA triad, attacks)', 'Kali Linux tools', 'Web Security (OWASP)', 'Vulnerability scanning', 'Metasploit basics', 'Reporting & documentation'],
            'Data Analyst': ['Excel fundamentals', 'SQL basics (joins, subqueries)', 'Data Cleaning & Preprocessing', 'Visualization tools (Power BI/Tableau)', 'Reports & dashboards', 'Basic analytics case studies'],
            'Full Stack Developer': ['HTML & CSS', 'JavaScript', 'Frontend Framework (React/Vue)', 'Backend Language (Node.js / Python)', 'Database (SQL/NoSQL)', 'APIs + Authentication', 'Deployment (Render, Vercel, AWS)'],
        };
        
        function findSkillByName(skillName) {
            return ALL_DB_SKILLS.find(s => s.name.trim() === skillName.trim());
        }

        function renderSkillSlider(skill) {
            const skillId = skill.id;
            const targetValue = skill.industryNeed;
            const initialValue = skill.currentLevel;
            const isClosed = initialValue >= targetValue;

            let gapText = isClosed ? 'Skill Gap: Closed!' : `Skill Gap: ${targetValue - initialValue} Levels to Close`;
            let valueClass = isClosed ? 'text-green-600' : 'text-red-500';
            let progressBarClass = isClosed ? 'bg-green-500' : 'bg-teal-500';
            
            return `
                <div class="border-b pb-6" data-skill-id="${skillId}" data-target-value="${targetValue}">
                    <h3 class="text-xl font-semibold mb-2 text-gray-800 flex justify-between items-center">
                        <span>${skill.name}</span>
                        <span class="text-teal-600 font-bold">Industry Need: ${targetValue}/5</span>
                    </h3>
                    
                    <div class="flex items-center space-x-4">
                        <label for="skill-${skillId}" class="text-sm font-medium text-gray-700 w-40">My Current Level:</label>
                        <input type="range" name="skill_${skillId}" min="1" max="5" value="${initialValue}" class="flex-grow h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" oninput="this.nextElementSibling.innerText = this.value; updateActionPlan()">
                        <span id="skill-${skillId}-value" class="w-8 text-center text-lg font-bold ${valueClass}">${initialValue}</span>
                    </div>

                    <div class="mt-3 progress-bg h-3 rounded-full overflow-hidden">
                        <div id="skill-${skillId}-progress" class="${progressBarClass} h-3" style="width: ${initialValue * 20}%;"></div> 
                    </div>
                    <p id="skill-${skillId}-gap-text" class="text-xs ${valueClass} mt-2 font-semibold">${gapText}</p>
                </div>
            `;
        }

        function loadRoadmap() {
            const select = document.getElementById('career-goal-select');
            let goalName = select.value;
            const assessmentContainer = document.getElementById('skills-assessment-container');
            const goalDescription = document.getElementById('goal-description');
            
            if (!goalName) {
                const firstGoal = select.options[0]?.value;
                if(firstGoal) {
                    select.value = firstGoal;
                    goalName = firstGoal;
                } else {
                    assessmentContainer.innerHTML = '<p class="text-center text-gray-500">Please select a career goal above.</p>';
                    return;
                }
            }

            const requiredSkillNames = ROADMAP_STRUCTURE[goalName] || [];
            const roadmapSkills = requiredSkillNames.map(name => findSkillByName(name)).filter(skill => skill);

            if (roadmapSkills.length === 0) {
                 assessmentContainer.innerHTML = '<p class="text-center text-red-500 font-semibold">Error: No matching skills found in DB.</p>';
                 return;
            }
            
            assessmentContainer.innerHTML = roadmapSkills.map(renderSkillSlider).join('');
            goalDescription.textContent = `Skills required for a top-tier **${goalName}** role.`;

            // Initialize action plan with DB values
            updateActionPlan(roadmapSkills); 
        }

        function updateActionPlan(initialSkills) {
            const list = document.getElementById('action-plan-list');
            list.innerHTML = '';
            
            // Grab current values from DOM sliders if they exist
            let skillsToCheck = initialSkills;
            const inputs = document.querySelectorAll('#skills-assessment-container input');
            
            if(inputs.length > 0) {
                 skillsToCheck = Array.from(inputs).map(input => {
                    const skillId = parseInt(input.name.replace('skill_', ''));
                    const skill = ALL_DB_SKILLS.find(s => s.id === skillId);
                    if(skill) {
                        // Create a copy with the current slider value
                        return { ...skill, currentLevel: parseInt(input.value) };
                    }
                    return null;
                 }).filter(s => s);
            }

            let hasGaps = false;

            skillsToCheck.forEach(skill => {
                const gap = skill.industryNeed - skill.currentLevel;

                if (gap > 0) {
                    hasGaps = true;
                    // Determine if already marked complete in DB
                    const isCompleted = skill.completedCount > 0; 
                    const btnClass = isCompleted ? 'bg-green-500 text-white cursor-default' : 'bg-gray-200 text-gray-700 hover:bg-green-100';
                    const btnText = isCompleted ? 'Completed' : 'Mark Complete';
                    const itemClass = isCompleted ? 'completed' : '';

                    // Tailored recommendation text
                    let actionText = `Complete a project or course for **${skill.name}**.`;
                    if (skill.name.includes('Python')) actionText = "Build a data analysis script using Pandas.";
                    else if (skill.name.includes('HTML')) actionText = "Build a responsive landing page.";
                    else if (skill.name.includes('SQL')) actionText = "Practice complex JOIN queries.";

                    const li = document.createElement('li');
                    li.className = `p-4 bg-gray-50 border rounded-lg shadow-sm flex justify-between items-center ${itemClass}`;
                    li.innerHTML = `
                        <div>
                            <p class="font-semibold text-red-500">Gap Detected: ${skill.name} (${gap} levels)</p>
                            <p class="text-sm text-gray-600">Action: ${actionText}</p>
                        </div>
                        <button class="text-xs py-2 px-4 rounded-full transition-ease font-bold ${btnClass}" 
                                onclick="markTechComplete(this, '${skill.name}')" ${isCompleted ? 'disabled' : ''}>
                            ${btnText}
                        </button>
                    `;
                    list.appendChild(li);
                }
            });

            if (!hasGaps) {
                list.innerHTML = `<li class="p-4 bg-green-50 border-l-4 border-green-400 rounded-lg shadow-sm"><p class="font-semibold text-gray-900">üéâ Congratulations! You have closed all gaps for this roadmap.</p></li>`;
            }
        }

        async function markTechComplete(btn, skillName) {
            btn.disabled = true;
            btn.innerText = "Saving...";
            
            try {
                const res = await fetch('/mark_activity_complete', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({skill_name: skillName})
                });
                
                const data = await res.json();
                
                if(data.success) {
                    btn.textContent = "Completed";
                    btn.className = "text-xs py-2 px-4 rounded-full transition-ease font-bold bg-green-500 text-white cursor-default";
                    btn.closest('li').classList.add('completed');
                } else {
                    alert("Error saving progress.");
                    btn.disabled = false;
                    btn.innerText = "Mark Complete";
                }
            } catch(e) {
                console.error(e);
                btn.disabled = false;
                btn.innerText = "Mark Complete";
            }
        }

        // --- Chatbot Logic ---
        function toggleChatbot() { 
            const w = document.getElementById('chatbot-window'); 
            w.style.display = (w.style.display === 'none' || w.style.display === '') ? 'flex' : 'none'; 
        }
        
        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const text = input.value;
            if(!text) return;
            
            const box = document.getElementById('chat-messages');
            box.innerHTML += `<div class="user-message">${text}</div>`;
            input.value = '';
            box.scrollTop = box.scrollHeight;
            
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text }] }] })
                });
                const data = await res.json();
                const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || "Sorry, I couldn't answer that.";
                box.innerHTML += `<div class="ai-message">${reply}</div>`;
            } catch(e) {
                box.innerHTML += `<div class="ai-message">Error connecting to AI.</div>`;
            }
            box.scrollTop = box.scrollHeight;
        }

        document.getElementById('chat-input').addEventListener('keypress', function(e) { if (e.key === 'Enter') sendMessage(); });

        // INITIALIZATION
        document.addEventListener('DOMContentLoaded', () => {
             loadRoadmap(); 
             // Force show chatbot button
             const btn = document.getElementById('chatbot-button');
             if(btn) btn.classList.remove('hidden');
        });
    </script>
</body>
</html>